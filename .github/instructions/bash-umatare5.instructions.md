---
description: "Bash Shell Script & Bootstrap System Instructions"
applyTo: "**/*.sh"
---

# Bash Shell **Scripts** & Bootstrap System Instructions

## Scope & Metadata

- **Last Updated**: 2025-08-11
- **Precedence**: 1. `copilot-instructions.md` (Global) → 2. `bash.instructions.md` (Community) → 3. `bash-umatare5.instructions.md` (This)
- **Compatibility**: POSIX-leaning / macOS bash 3.x compatible (`local -n` not allowed)
- **Style Base**: [Google Shell Style Guide](https://google.github.io/styleguide/shellguide.html)
- **Goal**: High-quality, maintainable, user-friendly scripts with a robust bootstrap system and strict dependency management.

## 1. Architecture

- **RS-001 (MUST)** Create entry points directly under `scripts/`.
- **RS-002 (MUST)** Under `lib`, create a directory per command/module; place the module entry in `core.sh`.
- **RS-003 (MUST)** Keep entry scripts minimal; implementation resides in module libraries.
- **RS-004 (SHOULD)** `core.sh` focuses on `run_*`/`execute_*` operations; split other responsibilities into dedicated files.
- **RS-005 (MUST)** Store cross-module shared functions under `lib/share`.
- **RS-006 (MUST)** Organize `lib/share` by responsibility (e.g., `argc/`, `utils/`, `http/`, `output/`, `testing/`).
- **RS-007 (MUST)** Entry scripts must source `lib/bootstrap.sh` **first**.
- **RS-008 (MUST)** Call chain flows **top-down** only: `scripts/<cmd>.sh → lib/<module>/core.sh → lib/share/...`.
- **RS-009 (MUST NOT)** Do not cross-reference siblings (`lib/<moduleA>/*` → `lib/<moduleB>/*`). Use `lib/share/*`.
- **RS-010 (MUST NOT)** Do not reference **upward** from lower layers (e.g., module → bootstrap).

## 1a. Bootstrap System

- **BS-001 (MUST)** Provide a single bootstrap loader: `lib/bootstrap.sh`.
- **BS-002 (MUST)** Bootstrap is sourced **only** by entry scripts in `scripts/`.
- **BS-003 (MUST NOT)** Libraries under `lib/` or `lib/share/` must **never** source `bootstrap.sh`.
- **BS-004 (MUST)** Use `init_libraries "<module_dir>"` for module loading.
- **BS-005 (MUST)** Define a stable `LIB_ROOT` (e.g., `PROJECT_LIB_ROOT`) used as the **anchor path** for discovery.
- **BS-006 (SHOULD)** Loading order guideline: **core → utils → http → testing → output → module-specific**.
- **BS-007 (MUST)** Implement dynamic library loading via a private loader (e.g., `_load_share_libraries()`).
- **BS-008 (MUST)** Use include-guards in every sourced file.

## 2. Coding Rules

- **SH-001 (MUST)** Prioritize human maintainability and readability.
- **SH-002 (MUST)** First line: `#!/usr/bin/env bash`.
- **SH-003 (MUST)** Strict mode (entry only): `set -euo pipefail` (custom `IFS` は必要時のみ設定).
- **SH-004 (MUST)** Indentation: **4 spaces**.
- **SH-005 (MUST)** Max **120 chars** per logical line.
- **SH-006 (MUST)** Functions target **10–20 lines**.
- **SH-007 (MUST)** Hard max **25 lines**（構造化 `case` は例外あり）。
- **SH-008 (MUST)** One-line purpose comment above each function.
- **SH-009 (MUST)** Naming: functions `lowercase_snake_case`; globals `readonly UPPERCASE_SNAKE_CASE`; locals `lowercase_snake_case`.
- **SH-010 (MUST)** Minimize globals; prefer `local`.
- **SH-011 (MUST)** Extract shared logic into helpers in `lib/share`.
- **SH-012 (MUST)** Favor portability; avoid OS/locale specifics; do not use `local -n`.
- **SH-013 (MUST)** Define defaults as `readonly` constants; allow overrides via **CLI flags** or **ENV**.
- **SH-014 (MUST)** Follow ShellCheck; prefer fixes over inline disables.
- **SH-015 (MUST)** Libraries must **not** alter `set -euo pipefail` or `IFS`.

## 2a. Library Behavior

- **LB-001 (MUST)** Do not change strict mode/IFS.
- **LB-002 (MUST)** Do not install global `trap`s; expose trap handlers as functions.
- **LB-003 (SHOULD)** Route output via logging utilities; avoid raw `echo`.
- **LB-004 (MUST)** Do not perform final argument parsing in libraries; provide validators/handlers only.
- **LB-005 (SHOULD)** Mask BSD/GNU diffs in shared utils (`stat`, `mktemp` など)。

## 3. Arguments & Help (if using `argc` or equivalent)

- **AR-001 (MUST)** Use metadata (`@flag`, `@arg`, `@option`) in entry scripts.
- **AR-002 (MUST)** Provide `@meta description`; rely on autogenerated help.
- **AR-003 (MUST)** Support short/long flags and ENV overrides.
- **AR-004 (SHOULD)** Declare defaults via `[default: …]`; mirror to `readonly` when needed.
- **AR-005 (SHOULD)** If a boolean defaults to `true`, add a negative flag (`--no-xxx`) or flip default to `false`.
- **AR-006 (SHOULD)** Support `--` passthrough to underlying tools.
- **AR-007 (MUST)** Resolution order: **argc → ENV (UPPERCASE) → defaults**.
- **AR-008 (SHOULD)** Library `handle_*`/`validate_*` return values via stdout; log via `log_*`.
- **AR-009 (MUST)** Use exit code **2** for argument errors.

## 4. Separation of Concerns & Validation

- **SC-001 (MUST)** Separate: parsing → env setup → core logic → output.
- **SC-002 (MUST)** Validate inputs/required ENV early.
- **SC-003 (MUST)** Verify external dependencies before execution; fail fast.

## 4a. Required CLI Tools (Profiles)

- **CLI-001 (MUST)** Entry scripts call `validate_required_cli_tools "<profile>"` at startup.
- **CLI-002 (MUST)** Profiles are defined in the repo (e.g., `standard`, `testing`, `coverage`).
- **CLI-003 (SHOULD)** On failure, list missing tools and installation hints.

## 4b. Flag Resolution (sample helpers)

```bash
# Global paths (check if already set to avoid conflicts)
if [[ -z "${WNC_LIB_ROOT:-}" ]]; then
    WNC_LIB_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    readonly WNC_LIB_ROOT
fi
```

## 5. Module Dependency Management

- **MD-001 (MUST)** Dependency hierarchy: **core → utils → domain-specific → module**.
- **MD-002 (MUST)** `lib/share/` is dependency-agnostic.
- **MD-003 (MUST)** `lib/<module>/` may depend on `lib/share/`.
- **MD-004 (MUST NOT)** No cross-module deps between `lib/<module1>/` and `lib/<module2>/`.
- **MD-005 (SHOULD)** Use ENV or function parameters for inter-module coordination.
- **MD-006 (MUST)** Document module dependencies in file headers.

## 5a. Circular Reference Prevention

- **CR-001 (MUST)** Libraries must not source the bootstrap loader.
- **CR-002 (MUST)** Implement include guards in **all** libraries:

  ```bash
  if [[ -n "${MODULE_NAME_LOADED:-}" ]]; then
    return 0
  fi
  readonly MODULE_NAME_LOADED=1
  ```

- **CR-003 (MUST)** Set the `*_LOADED` guard (`readonly`) after the check.
- **CR-004 (MUST NOT)** Avoid A↔B cycles.
- **CR-005 (SHOULD)** Prefer dependency injection (pass function refs/params) over direct sourcing.

## 6. Library Loading Optimization

- **LO-001 (MUST)** Implement loading order in bootstrap: **critical → optional → module**.
- **LO-002 (MUST)** Use include guards to prevent duplicate loads.
- **LO-003 (SHOULD)** Group loaders: `source_core_libraries`, `source_utils_libraries`, etc.
- **LO-004 (MUST)** Validate file existence before sourcing: `[[ -f "$lib_file" ]]`.
- **LO-005 (SHOULD)** Lazy-load expensive operations when possible.

## 7. Output / UX (Logging)

- **UX-001 (MUST)** Use `log_info` / `log_success` / `log_warn` / `log_error`.
- **UX-002 (MUST)** Color by default; fallback to no-color when `NO_COLOR`/`CI` or predicate enabled.
- **UX-003 (MUST)** Streams: warns/errors → **stderr**; info/success → **stdout**.
- **UX-004 (MUST)** Use `printf` (avoid `echo -e`).
- **UX-005 (SHOULD)** Assume UTF-8; provide ASCII fallbacks.
- **UX-006 (SHOULD)** Provide `show_*_banner`/`show_*_help`; tolerate absence.
- **UX-007 (SHOULD)** Provide `show_status <context>` and gate verbosity.
- **UX-008 (MUST NOT)** Do not hardcode ANSI codes outside helpers.
- **UX-009 (SHOULD)** For generated artifacts, include OS-specific open tips.

**Sample**

```bash
log_info() {
  if is_no_color_enabled; then
    printf "Info: %s\n" "$*"
    return 0
  fi
  printf "\033[36mℹ Info:\033[0m %s\n" "$*"
}
```

## 8. Conditionals

- **PR-001 (MUST)** Do not reference `argc_*` directly in conditionals; wrap with predicates.
- **PR-002 (MUST)** Prefer early returns.

## 8a. Conditional Statement Style

- **CS-001 (MUST)** Avoid short-circuit forms (`[[ cond ]] && cmd` / `|| cmd`).
- **CS-002 (MUST)** Use explicit `if ... then ... fi`.

## 9. External HTTP (if applicable)

- **NET-001 (MUST)** Execute `curl` via shared HTTP helpers with `--fail` and `--show-error`.
- **NET-002 (MUST)** Example headers: `Authorization: Bearer ${TOKEN}`, `Accept: ${ACCEPT:-application/json}`.
- **NET-003 (MUST)** Validate required ENV early.
- **NET-004 (SHOULD)** Reuse a common CURL args builder.

**Validation sample**

```bash
validate_env() {
  if [[ -z "${API_BASE_URL:-}" ]]; then log_error "API_BASE_URL required"; exit 1; fi
  if [[ -z "${TOKEN:-}"       ]]; then log_error "TOKEN required"; exit 1; fi
}
```

## 10. Temporary Files / Cleanup

- **TMP-001 (MUST)** Create temporary files under `./tmp`.
- **TMP-003 (SHOULD)** Use portable `mktemp` templates (e.g., `mktemp "${TMPDIR:-/tmp}/${PROJECT_SLUG:-proj}.XXXXXX"`).

## 11. Error Handling & Exit Codes

- **EX-001 (MUST)** `0` = success.
- **EX-002 (MUST)** On error, write to **stderr** and exit non-zero.
- **EX-003 (MUST)** Exit codes: `1` = runtime/env error, `2` = argument/usage error.
- **EX-004 (MUST)** Validators may exit immediately with appropriate code.
- **EX-005 (SHOULD)** Numeric codes (`exit 2`) are acceptable; a helper may wrap them.
- **EX-006 (SHOULD)** For unknown options, print a usage hint to **stderr**.

## 12. Testing & Diagnostics

- **TV-001 (MUST)** Validate bootstrap integrity before main ops.
- **TV-002 (MUST)** Test circular-reference prevention (e.g., `bash -x`).
- **TV-003 (SHOULD)** Implement module isolation tests.
- **TV-004 (MUST)** Validate required functions are available after bootstrap.
- **TV-005 (SHOULD)** Provide diagnostic commands for troubleshooting library loading.

## 13. Function Design Patterns

- **FD-001 (MUST)** Prefix private functions with `_`.
- **FD-002 (MUST)** Use arrays/loops to eliminate duplicated `source`/checks.
- **FD-003 (SHOULD)** Manage conditional loads with `required_scripts[]` and `optional_scripts[]`.
- **FD-004 (MUST NOT)** Avoid short-circuit forms; use explicit `if`.

## 14. Function Definition Order

- **FO-001 (MUST)** Order: (1) globals/init → (2) private (`_`) → (3) public (by feature) → (4) main → (5) exports.
- **FO-002 (SHOULD)** In private funcs: **predicates → workers/operations**。

## 15. Array Usage Patterns

- **AU-001 (MUST)** Define filenames in arrays and loop over them for loads.
- **AU-002 (SHOULD)** Use `priority_scripts[]` for ordered execution.
- **AU-003 (SHOULD)** Track `skip_scripts[]` and decide with predicates.

## 16. Module Loading Patterns

- **ML-001 (MUST)** Load in this order within a module: `predicate.sh` → `banner.sh` → `help.sh` → other features → `core.sh`.
- **ML-002 (SHOULD)** Implement stages as private loaders: `_load_priority_scripts`, `_load_other_scripts`, `_load_core_script`.

## Appendix A: Recommended Directory Layout (General)

```
scripts/
├── <cmd>.sh
└── lib
    ├── bootstrap.sh
    ├── <moduleA>
    │   ├── core.sh          # module entry
    │   ├── operations.sh
    │   ├── predicate.sh
    │   ├── banner.sh
    │   └── help.sh
    ├── <moduleB>/
    └── share/
        ├── argc/            # argument parser helpers (if used)
        ├── core/            # constants, predicates, argument helpers
        ├── http/            # HTTP helpers (optional)
        ├── output/          # log.sh defines log_* family
        ├── utils/
        ├── artifacts/       # artifact & cleanup helpers
        ├── coverage/        # coverage report helpers
        ├── dependencies/    # CLI/dep validation
        ├── testing/         # test orchestration helpers
        └── validation/      # policy/structure validation
```

## Appendix B: Include-Guard Pattern

```bash
# lib/foo/core.sh
if [[ -n "${MOD_FOO_CORE_LOADED:-}" ]]; then
  return 0
fi
readonly MOD_FOO_CORE_LOADED=1
# module code follows...
```

## Appendix C: Entry Script Skeleton (argc + bootstrap + core.sh)

```bash
#!/usr/bin/env bash
# @meta version 1.0.0
# @meta author "@auther"
# @describe Lint Script - Code linting

# @option -p --project <DIR>           Project root directory [default: .]
# @flag   -v --verbose                 Enable verbose output
# @flag      --fix                     Automatically fix issues where possible
# @option    --config <FILE>           Custom config path
# @flag      --no-color                Disable colored output

set -euo pipefail
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"; readonly SCRIPT_DIR
source "${SCRIPT_DIR}/lib/bootstrap.sh"

# Initialize module libraries
init_libraries "${SCRIPT_DIR}/lib/lint"
source "${SCRIPT_DIR}/lib/lint/core.sh"

# Validate required CLI tools
validate_required_cli_tools "standard"

main() {
  local project_root="${argc_project:-.}"
  run_lint_operation "$project_root"
}

# Evaluate argc then run (if using argc)
eval "$(argc --argc-eval "$0" "$@")"
main "$@" || exit $?
```
